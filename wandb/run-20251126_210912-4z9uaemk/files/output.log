
Step 1: 读取数据并构建四特征...
Step 2: 构建四输入样本...
f:\Codes\Wd-Pred\transformer_prediction.py:84: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  history_map = df.groupby('Username').apply(
数据集划分：训练集 3093918, 验证集 441988, 测试集 883978
Step 3: 检测到已保存模型 Transformer_Model，尝试加载...
❌ 模型加载失败: SavedModel file does not exist at: Transformer_Model\{saved_model.pbtxt|saved_model.pb}. 将重新构建并训练模型。
Step 3: 构建Transformer神经网络 (Vocab=321)...
Step 4: 开始训练 (Epochs=10, Batch=2048)...
Epoch 1/10













1511/1511 [==============================] - 28s 18ms/step - loss: 1.7170 - output_steps_loss: 1.6403 - output_success_loss: 0.1534 - output_success_accuracy: 0.9622 - val_loss: 1.3631 - val_output_steps_loss: 1.3029 - val_output_success_loss: 0.1205 - val_output_success_accuracy: 0.9640
Epoch 2/10











1511/1511 [==============================] - 24s 16ms/step - loss: 1.3667 - output_steps_loss: 1.3056 - output_success_loss: 0.1221 - output_success_accuracy: 0.9641 - val_loss: 1.4604 - val_output_steps_loss: 1.4014 - val_output_success_loss: 0.1181 - val_output_success_accuracy: 0.9649
Epoch 3/10











1511/1511 [==============================] - 24s 16ms/step - loss: 1.3495 - output_steps_loss: 1.2894 - output_success_loss: 0.1203 - output_success_accuracy: 0.9644 - val_loss: 1.5119 - val_output_steps_loss: 1.4530 - val_output_success_loss: 0.1179 - val_output_success_accuracy: 0.9651
Epoch 4/10











1511/1511 [==============================] - 25s 16ms/step - loss: 1.3453 - output_steps_loss: 1.2856 - output_success_loss: 0.1193 - output_success_accuracy: 0.9646 - val_loss: 1.4819 - val_output_steps_loss: 1.4231 - val_output_success_loss: 0.1177 - val_output_success_accuracy: 0.9651
Epoch 5/10











1511/1511 [==============================] - 25s 16ms/step - loss: 1.3429 - output_steps_loss: 1.2835 - output_success_loss: 0.1188 - output_success_accuracy: 0.9647 - val_loss: 1.4439 - val_output_steps_loss: 1.3853 - val_output_success_loss: 0.1173 - val_output_success_accuracy: 0.9652
Epoch 6/10











1511/1511 [==============================] - 24s 16ms/step - loss: 1.3411 - output_steps_loss: 1.2818 - output_success_loss: 0.1185 - output_success_accuracy: 0.9648 - val_loss: 1.4972 - val_output_steps_loss: 1.4383 - val_output_success_loss: 0.1177 - val_output_success_accuracy: 0.9651
Epoch 7/10











1511/1511 [==============================] - 24s 16ms/step - loss: 1.3402 - output_steps_loss: 1.2810 - output_success_loss: 0.1183 - output_success_accuracy: 0.9648 - val_loss: 1.4795 - val_output_steps_loss: 1.4209 - val_output_success_loss: 0.1172 - val_output_success_accuracy: 0.9652
Epoch 8/10











1511/1511 [==============================] - 24s 16ms/step - loss: 1.3395 - output_steps_loss: 1.2805 - output_success_loss: 0.1181 - output_success_accuracy: 0.9648 - val_loss: 1.4432 - val_output_steps_loss: 1.3848 - val_output_success_loss: 0.1169 - val_output_success_accuracy: 0.9653
Epoch 9/10












1511/1511 [==============================] - 27s 18ms/step - loss: 1.3392 - output_steps_loss: 1.2802 - output_success_loss: 0.1180 - output_success_accuracy: 0.9649 - val_loss: 1.4938 - val_output_steps_loss: 1.4348 - val_output_success_loss: 0.1179 - val_output_success_accuracy: 0.9651
Epoch 10/10












1511/1511 [==============================] - 25s 16ms/step - loss: 1.3388 - output_steps_loss: 1.2799 - output_success_loss: 0.1179 - output_success_accuracy: 0.9648 - val_loss: 1.4897 - val_output_steps_loss: 1.4312 - val_output_success_loss: 0.1170 - val_output_success_accuracy: 0.9653
✅ Loss曲线已保存至: visualization\Transformer_loss_curve.png
✅ 模型已成功保存到文件夹: Transformer_Model
Step 4: 开始批量预测，显示进度条...
216/216 [==============================] - 2s 7ms/step
Step 4: 开始批量预测，显示进度条...
432/432 [==============================] - 3s 7ms/step
========================================
  Transformer模型验证和测试报告
========================================
---- 验证集指标 ----
1. 平均步数误差 (MAE)    : 0.9780
2. 均方根误差 (RMSE)     : 1.1963
3. 胜负预测准确率        : 96.528%
4. ROC曲线下面积 (AUC)   : 0.8675
5. 大型误差率 (>1.5步)  : 21.917%
---- 测试集指标 ----
1. 平均步数误差 (MAE)    : 0.9775
2. 均方根误差 (RMSE)     : 1.1962
3. 胜负预测准确率        : 96.464%
4. ROC曲线下面积 (AUC)   : 0.8682
5. 大型误差率 (>1.5步)  : 21.904%
========================================
Step 5: 启动回测验证抽样报告 (样本数=10000, 输出至 output.txt)...
------------------------------------------------------------
User ID    | Bias  | Diff  | Real  | Pred  | Err   | Status
------------------------------------------------------------
343036     | 4.62  | 4.07  | 6    | 4.00  | 2.00  | ❌
794861     | 3.72  | 4.29  | 5    | 3.36  | 1.64  | ❌
135654     | 3.94  | 4.46  | 3    | 3.73  | 0.73  | ✅
22139      | 5.00  | 4.58  | 5    | 4.86  | 0.14  | ✅
814026     | 5.00  | 4.59  | 5    | 4.81  | 0.19  | ✅
105840     | 4.25  | 4.35  | 4    | 3.98  | 0.02  | ✅
549816     | 4.31  | 4.24  | 3    | 3.71  | 0.71  | ✅
727848     | 4.52  | 4.72  | 3    | 4.43  | 1.43  | ⚠️
103119     | 4.27  | 4.72  | 6    | 4.30  | 1.70  | ❌
212538     | 5.67  | 4.45  | 6    | 4.96  | 1.04  | ⚠️
... (其余 9990 条省略)
✅ 抽样报告已成功导出至 outputs/transformer_output.txt 文件。
✅ 预测趋势图已保存至: visualization\Transformer_prediction_trends.png